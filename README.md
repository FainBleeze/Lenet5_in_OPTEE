# Lenet5_in_TEE



## 一、初步分析



### 1. 一般环境下的Lenet5源码

##### 代码来源

本应用中使用的Lenet5源码来自于https://github.com/fan-wenjie/LeNet-5，该项目使用**C语言**完成，没有依赖其他第三方库，在windows和Linux环境下通过简单的编译和极少的改动即可正确运行



##### 代码结构

代码结构如下：

- lenet.h：定义结构变量，提供神经网络接口
- lenet.c：实现卷积神经网络的主要计算功能，提供初始化、训练和预测接口的具体实现
- main.c：打开训练集并分组，调用卷积神经网络接口训练模型，并针对测试集给出预测结果
- 训练集与测试集



##### 执行分析

程序运行一次的执行流程如下：

1. 读取数据集（训练集和测试集）
2. 模型初始化
3. 训练集分组
4. 训练模型
5. 模型测试
6. 统计数据



### 2. TEE中的Lenet5

##### 总体目标

现有的代码可以在Rich OS中编译执行，但不可以直接放在TEE环境中执行。

本项目的目标是将卷积神经网络的计算过程与TEE（可信执行环境）相结合，作为TEE实验的初次尝试。



##### 项目规划

一个TEE中的安全应用分为两部分，分别是在安全环境中执行的**安全应用TA**和在非安全环境中执行的**客户应用CA**

2. TEE通过共享内存的方式与Linux中的应用进行通信，共享内存的大小有限；

3. CPU在安全世界和非安全世界之间进行一次切换需要进行多次系统调用和上下文切换，频繁切换会带来性能上的损耗

考虑到以上几点因素，TEE中的代码应该尽量少，即只将关键的功能函数放入TEE执行。同时，衡量第12点带来的数据大小的限制和第2点带来的性能损耗，提出的第一个设计方案如下：

- 训练阶段
  - 客户应用CA：打开整个训练集并进行分组，调用TA中的接口进行训练
  - 安全应用TA：每次接收一组数据，对模型进行训练，模型参数保存在TEE内部以利用TEE的安全性，除了执行结果不返回任何值
- 测试阶段
  - 客户应用CA：打开整个测试集并进行分组，调用TA中的接口进行预测
  - 安全应用TA：接受一组数据，使用训练好的模型进行预测，返回预测结果